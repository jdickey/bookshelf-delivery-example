#!/bin/bash

# This works for MRI; it may or may not work for other Rubies.
RUBY_VERSION=`ruby --version | cut -d ' ' -f 2 | sed 's/p.*//'`

##
## Initialise Gemset and setup if `rbenv` is available
##

rm -f Gemfile.lock
rm -f .rbenv-gemsets

if [[ `rbenv --version 2>/dev/null` ]]; then
  rbenv gemset delete $RUBY_VERSION ./tmp/gemset 2>/dev/null || true
  find ./tmp/gemset -delete 2>/dev/null || true
  rbenv rehash
  rbenv gemset create $RUBY_VERSION ./tmp/gemset
  echo ./tmp/gemset > .rbenv-gemsets
  # echo hanami >> .rbenv-gemsets
  rbenv rehash
fi

##
## Install Gems
##
## The point of using the `--ignore-dependencies` option to `gem install` is so
## that dependencies which we (accidentally) omit shouldn't be installed; that
## *should* cause `bundle install --local` to fail.

gem install --ignore-dependencies yard -v 0.9.15
yard config --gem-install-yri

gem install --ignore-dependencies mini_mime:1.0.0 # dependency of mail:2.7.0; no --no-doc required
gem install --ignore-dependencies --no-doc mail:2.7.0 # does not play nicely with YARD


# dry-validation is a dependency of hanami-validations. All the other dry-rb
# Gems here(!) are direct/indirect dependencies of dry-validation.

gem install --ignore-dependencies concurrent-ruby:1.0.2 dry-configurable:0.3.0 dry-container:0.5.0 \
            dry-core:0.2.0 dry-equalizer:0.2.0 dry-logic:0.4.0 \
            inflecto:0.0.2 dry-types:0.9.1 dry-validation:0.10.3

# Remember that `hanami-mailer` depends on `mail`, which we've installed earlier
# because of version 2.7.0's conflict with YARD. (Hanami 0.8 defaulted to
# Version 2.6.4, which had no such conflict.)
gem install --ignore-dependencies hanami-utils:0.8.0 hanami-helpers:0.4.0 \
            tilt:2.0.5 hanami-assets:0.3.0 \
            hanami-controller:0.7.1 \
            hanami-mailer:0.3.0 \
            url_mount:0.2.1 http_router:0.11.2 hanami-router:0.7.0 \
            hanami-validations:0.6.0 \
            hanami-view:0.7.0 \
            thor:0.19.1 hanami:0.8.0


# In-progress updates follow

gem install --ignore-dependencies jaro_winkler:1.5.1 parallel:1.12.1 ast:2.4.0 parser:2.5.1.2 powerpack:0.1.1 \
            rainbow:3.0.0 ruby-progressbar:1.8.1 unicode-display_width:1.1.1 rubocop:0.58.2

# Updated installs below

gem install --ignore-dependencies sequel:4.49.0 pg:1.0.0 hanami-model:0.6.1

gem install --ignore-dependencies byebug:10.0.2 coderay:1.1.1 method_source:0.8.2 slop:3.6.0 pry:0.10.4 pry-byebug:3.6.0
gem install --ignore-dependencies rake:12.3.1
gem install --ignore-dependencies multi_json:1.13.1
gem install --ignore-dependencies uber:0.0.15 declarative:0.0.10 declarative-option:0.1.0 representable:3.0.4 roar:1.1.0
gem install --ignore-dependencies shotgun:0.9.2
gem install --ignore-dependencies dotenv:2.5.0
gem install --ignore-dependencies minitest:5.11.3
# Rack 2.0.5 and rack-test 1.1.0 are current. hanami-controller 0.7 depends on Rack ~> 1.6.
gem install --ignore-dependencies public_suffix:3.0.2 addressable:2.5.2 mini_mime:1.0.0 mini_portile2:2.3.0 nokogiri:1.8.4 \
                                  rack:1.6.10 rack-test:1.1.0 mini_mime:1.0.0 xpath:3.1.0 capybara:3.5.1


#

bundle install --binstubs --local --with development,test
